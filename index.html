<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC Food Rescue Map</title>
    
    <!-- Leaflet CSS (The Map Engine) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- DARK THEME STYLING --- */
        :root {
            --bg-color: #121212;
            --sidebar-bg: #1e1e1e;
            --text-main: #ffffff;
            --text-muted: #aaaaaa;
            --accent: #00cc88; /* TGTG Brand Green */
            --danger: #ff4757;
            --border: #333;
        }

        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-main); overflow: hidden; }
        
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* Floating Sidebar */
        .sidebar {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 360px;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 24px;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        /* Typography */
        h1 { margin: 0 0 5px 0; font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
        h1 span { color: var(--accent); }
        .subtitle { font-size: 11px; color: var(--text-muted); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

        /* Stats Row */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: #2a2a2a;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #333;
        }
        .stat-val { font-size: 22px; font-weight: 800; color: var(--accent); }
        .stat-label { font-size: 11px; color: var(--text-muted); font-weight: 500; margin-top: 2px; }

        /* Inputs */
        .control-group { margin-bottom: 18px; }
        label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--text-muted); }
        
        input[type="text"], select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #2a2a2a;
            color: white;
            font-family: inherit;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, select:focus { outline: none; border-color: var(--accent); }

        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        
        /* Range Slider */
        input[type=range] { width: 100%; accent-color: var(--accent); }

        /* Custom Popup Styles */
        .leaflet-popup-content-wrapper {
            background: #2a2a2a;
            color: var(--text-main);
            border-radius: 8px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .leaflet-popup-tip { background: #2a2a2a; }
        .leaflet-popup-content { margin: 0; width: 280px !important; }

        .popup-header {
            height: 120px;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        .popup-rating {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.85);
            color: #ffd700;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            backdrop-filter: blur(4px);
        }
        .popup-body { padding: 16px; }
        .popup-title { font-weight: 700; font-size: 16px; margin-bottom: 4px; line-height: 1.3; }
        .popup-cat { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 12px; }
        
        .popup-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .popup-price { font-size: 18px; font-weight: 700; color: var(--accent); }
        .popup-old-price { font-size: 13px; text-decoration: line-through; color: #666; font-weight: normal; margin-left: 6px; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        .badge-avail { background: rgba(0, 204, 136, 0.2); color: var(--accent); border: 1px solid rgba(0, 204, 136, 0.3); }
        .badge-out { background: rgba(255, 255, 255, 0.1); color: #888; }

        .popup-btn {
            display: block;
            background: var(--accent);
            color: #000;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 700;
            font-size: 13px;
            transition: opacity 0.2s;
        }
        .popup-btn:hover { opacity: 0.9; }

        /* Loading Overlay */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loader">
        <div class="spinner"></div>
        <div style="font-size: 14px; color: #888;">Fetching latest NYC data...</div>
    </div>

    <div id="map"></div>

    <div class="sidebar">
        <h1>NYC <span>Food Rescue</span></h1>
        <div class="subtitle" id="last-updated">Last Scan: Waiting...</div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-val" id="total-visible">0</div>
                <div class="stat-label">Stores Shown</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="total-bags">0</div>
                <div class="stat-label">Bags Available</div>
            </div>
        </div>

        <div class="control-group">
            <label>üîé Search</label>
            <input type="text" id="search-input" placeholder="Search stores (e.g. Eataly, Pizza)...">
        </div>

        <div class="control-group">
            <div class="toggle-row">
                <label>‚≠ê Minimum Rating</label>
                <span id="rating-val" style="font-size: 12px; font-weight: bold; color: var(--accent);">0.0</span>
            </div>
            <input type="range" id="rating-slider" min="0" max="5" step="0.1" value="0">
        </div>

        <div class="control-group">
            <div class="toggle-row">
                <label>üì¶ Availability</label>
                <label style="cursor: pointer; display: flex; align-items: center;">
                    <input type="checkbox" id="available-check" style="margin-right: 8px;">
                    Hide Sold Out
                </label>
            </div>
        </div>

        <div class="control-group">
            <label>üó∫Ô∏è Map Mode</label>
            <select id="view-mode">
                <option value="markers">üìç Interactive Markers</option>
                <option value="heatmap">üî• Heatmap Density</option>
            </select>
        </div>
        
        <div style="margin-top: 20px; border-top: 1px solid #333; padding-top: 15px;">
            <p style="font-size: 11px; color: #666; line-height: 1.5;">
                <strong>About:</strong> This map scans all 5 boroughs of NYC to find surplus food bags. Data updates automatically twice daily via GitHub Actions.
            </p>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Heatmap Plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>

    <script>
        // 1. Initialize Map (Centered on NYC)
        const map = L.map('map', { zoomControl: false }).setView([40.7306, -73.9352], 11);
        L.control.zoom({ position: 'topright' }).addTo(map);

        // Dark Mode Map Tiles
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        let allData = [];
        let markersLayer = L.layerGroup().addTo(map);
        let heatLayer = null;

        // 2. Load Data from the JSON file generated by Python
        fetch('nyc_data.json')
            .then(response => response.json())
            .then(data => {
                allData = data.stores;
                document.getElementById('last-updated').innerText = `Last Scan: ${data.updated_at}`;
                document.getElementById('loader').style.display = 'none'; // Hide loader
                
                // Initial Filter & Render
                filterData();
            })
            .catch(err => {
                console.error(err);
                document.getElementById('loader').innerHTML = `<div style="color:red; text-align:center;">Error loading nyc_data.json<br>Did the Action run yet?</div>`;
            });

        // 3. Render Functions
        function renderMap(stores) {
            markersLayer.clearLayers();
            if (heatLayer) map.removeLayer(heatLayer);

            const mode = document.getElementById('view-mode').value;

            if (mode === 'markers') {
                stores.forEach(store => {
                    const isAvailable = store.available > 0;
                    
                    // Style points: Green glow for available, dim gray for sold out
                    const color = isAvailable ? '#00cc88' : '#444444';
                    const radius = isAvailable ? 6 : 3;
                    const opacity = isAvailable ? 1 : 0.4;
                    const zIndex = isAvailable ? 1000 : 1; // Available items on top

                    const marker = L.circleMarker([store.lat, store.lng], {
                        radius: radius,
                        fillColor: color,
                        color: isAvailable ? '#ffffff' : '#000000',
                        weight: isAvailable ? 1 : 0,
                        opacity: 1,
                        fillOpacity: opacity
                    });

                    // Build the Popup HTML
                    const popupHTML = `
                        <div class="popup-header" style="background-image: url('${store.cover_image || ''}')">
                            <div class="popup-rating">‚òÖ ${store.rating ? store.rating.toFixed(1) : 'N/A'}</div>
                        </div>
                        <div class="popup-body">
                            <div class="popup-title">${store.name}</div>
                            <div class="popup-cat">${store.category}</div>
                            
                            <div class="popup-row">
                                <div class="popup-price">
                                    ${store.currency} ${store.price}
                                    <span class="popup-old-price">${store.original_price}</span>
                                </div>
                                <span class="badge ${isAvailable ? 'badge-avail' : 'badge-out'}">
                                    ${isAvailable ? store.available + ' Left' : 'Sold Out'}
                                </span>
                            </div>

                            <a href="https://share.toogoodtogo.com/item/${store.id}" target="_blank" class="popup-btn">
                                View in App
                            </a>
                        </div>
                    `;

                    marker.bindPopup(popupHTML);
                    markersLayer.addLayer(marker);
                });
            } else if (mode === 'heatmap') {
                // Heatmap Weighting:
                // We weight by 'available' so that hotspots of *available* food glow brightest.
                const heatPoints = stores.map(s => {
                    // If available, weight is high (1.0). If sold out, weight is low (0.1) just to show store density.
                    const intensity = s.available > 0 ? 1.0 : 0.1; 
                    return [s.lat, s.lng, intensity];
                });

                heatLayer = L.heatLayer(heatPoints, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 13,
                    gradient: {0.2: '#2c3e50', 0.4: '#e67e22', 0.6: '#f1c40f', 1: '#00cc88'}
                }).addTo(map);
            }
        }

        // 4. Filtering Logic
        function filterData() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const minRating = parseFloat(document.getElementById('rating-slider').value);
            const hideSoldOut = document.getElementById('available-check').checked;

            const filtered = allData.filter(store => {
                // Search Text
                const matchesSearch = store.name.toLowerCase().includes(searchTerm) || 
                                      (store.category && store.category.toLowerCase().includes(searchTerm));
                
                // Rating Filter
                const matchesRating = store.rating >= minRating;
                
                // Availability Filter
                const matchesAvail = hideSoldOut ? store.available > 0 : true;

                return matchesSearch && matchesRating && matchesAvail;
            });

            // Update UI
            document.getElementById('total-visible').innerText = filtered.length;
            const totalBags = filtered.reduce((acc, curr) => acc + curr.available, 0);
            document.getElementById('total-bags').innerText = totalBags;

            renderMap(filtered);
        }

        // 5. Interaction Listeners
        document.getElementById('search-input').addEventListener('input', filterData);
        document.getElementById('rating-slider').addEventListener('input', (e) => {
            document.getElementById('rating-val').innerText = e.target.value;
            filterData();
        });
        document.getElementById('available-check').addEventListener('change', filterData);
        document.getElementById('view-mode').addEventListener('change', () => {
            // Re-render map in new mode
            filterData(); 
        });

    </script>
</body>
</html>
